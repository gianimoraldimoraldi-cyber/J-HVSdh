<script>
    // Funzione tecnica per convertire la chiave (non toccare)
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    const publicVapidKey = 'BAs_7P_q9-Fv5N-7_9vYV-9v7v9v_v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v7v9v4'; // Nuova Chiave Certificata

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    document.getElementById('main-btn').onclick = async () => {
        const registration = await navigator.serviceWorker.ready;
        
        try {
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array('BFY6p9Z9zV9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9') // Chiave Standard
            });

            // INVIO A PIPEDREAM
            await fetch('https://eohg99rpfo5glba.m.pipedream.net', {
                method: 'POST',
                body: JSON.stringify(subscription),
                headers: { 'Content-Type': 'application/json' }
            });
            alert('SINCRONIZZAZIONE COMPLETATA!');
        } catch (err) {
            console.error('Errore durante la sottoscrizione:', err);
        }
    };
</script>
